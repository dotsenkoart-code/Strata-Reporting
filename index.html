<!DOCTYPE html>
<html>
<head>
    <title>Strata Command Center | Review Pipeline</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #0f111a; color: #fff; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0cf; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 900; letter-spacing: 1px; color: #fff; }
        .header span { color: #0cf; }
        
        .upload-zone { background: #1a1d27; border: 2px dashed #333; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .upload-zone:hover { border-color: #0cf; background: #202430; }
        .upload-zone h2 { margin: 0 0 10px 0; color: #888; font-size: 1.2rem; }
        
        .stats-bar { display: flex; gap: 15px; margin-bottom: 20px; display: none; }
        .stat-card { flex: 1; background: #1a1d27; padding: 15px; border-radius: 8px; border-left: 4px solid #333; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .stat-value { font-size: 2rem; font-weight: 900; margin-top: 5px; }

        /* --- THE BUILDING GRID --- */
        #building-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; }
        .drop-column { background: #161922; border: 1px solid #2a2d38; border-radius: 8px; padding: 15px; min-width: 250px; }
        .drop-header { text-align: center; font-size: 1.2rem; font-weight: bold; color: #0cf; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .floor-row { display: flex; align-items: center; margin-bottom: 8px; }
        .floor-label { width: 40px; font-weight: bold; color: #666; font-size: 0.9rem; text-align: right; margin-right: 10px; }
        
        .window-group { display: flex; gap: 4px; flex: 1; justify-content: center; }
        .window-node { width: 45px; height: 60px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: rgba(255,255,255,0.9); border: 2px solid rgba(0,0,0,0.5); transition: transform 0.1s; }
        .window-node:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.8); z-index: 10; }
        
        /* Workflow Colors */
        .status-clear { background: #28a745; } /* Green: Good */
        .status-flagged { background: #f1c40f; color: #000; } /* Yellow: Tech flagged it */
        .status-confirmed { background: #d9534f; } /* Red: Management confirmed */
        .status-empty { background: #222; border: 2px dashed #444; color: #555; pointer-events: none; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-box { background: #1a1d27; border: 1px solid #0cf; border-radius: 12px; padding: 25px; width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.9); }
        .modal-title { font-size: 2rem; color: #0cf; margin: 0 0 5px 0; font-weight: 900; }
        .modal-subtitle { color: #888; margin-bottom: 20px; font-size: 0.9rem; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
        .data-label { color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .data-val { font-weight: bold; text-align: right; max-width: 60%; }
        
        .manager-section { margin-top: 20px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .modal-notes { width: 100%; height: 80px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 10px; margin-top: 5px; font-family: inherit; resize: none; box-sizing: border-box; }
        
        .btn-confirm { width: 100%; padding: 15px; margin-top: 15px; background: #d9534f; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 900; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-confirm:hover { background: #c9302c; }
        
        .btn-close { width: 100%; padding: 12px; margin-top: 10px; background: #333; color: #ccc; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-close:hover { background: #444; }

        .top-btn { background: #0cf; color: #000; padding: 10px 20px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; display: none; }
        .top-btn:hover { background: #00aadd; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>STRATA COMMAND <span>| Review Pipeline</span></h1>
            <div id="project-name" style="font-weight: bold; color: #888; margin-top: 5px;">Awaiting Data...</div>
        </div>
        <button class="top-btn" id="btn-export" onclick="exportReviewedCSV()">ðŸ’¾ EXPORT REVIEWED CSV</button>
    </div>

    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
    <div class="upload-zone" id="drop-zone" onclick="document.getElementById('csvFileInput').click()">
        <h2>ðŸ“¥ Drop Field CSV Here</h2>
        <p style="color:#555; margin:0; font-size:0.9rem;">or click to browse your computer</p>
    </div>

    <div class="stats-bar" id="stats-bar">
        <div class="stat-card" style="border-color:#28a745;">
            <div class="stat-label">Total Windows Scanned</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card" style="border-color:#f1c40f;">
            <div class="stat-label">Unconfirmed Flags (Yellow)</div>
            <div class="stat-value" id="stat-flagged" style="color:#f1c40f;">0</div>
        </div>
        <div class="stat-card" style="border-color:#d9534f;">
            <div class="stat-label">Confirmed Defects (Red)</div>
            <div class="stat-value" id="stat-confirmed" style="color:#d9534f;">0</div>
        </div>
    </div>

    <div id="building-container">
        </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-box">
            <h2 class="modal-title" id="m-id">A-12-L</h2>
            <div class="modal-subtitle" id="m-tech">Logged by Tech at 14:30</div>
            
            <div class="data-row"><span class="data-label">Findings</span><span class="data-val" id="m-finds" style="color:#f1c40f;">--</span></div>
            <div class="data-row"><span class="data-label">Moisture %</span><span class="data-val" id="m-moisture">--</span></div>
            <div class="data-row"><span class="data-label">Meter Proved</span><span class="data-val" id="m-proved">--</span></div>
            <div class="data-row"><span class="data-label">FLIR Image</span><span class="data-val" id="m-flir" style="color:#0cf;">--</span></div>
            
            <div class="manager-section">
                <span class="data-label" style="color:#fff;">Management Notes</span>
                <textarea id="m-notes" class="modal-notes" placeholder="e.g. Schedule sealant replacement..."></textarea>
                
                <button id="btn-confirm-issue" class="btn-confirm" onclick="confirmIssue()">ðŸš¨ CONFIRM ISSUE</button>
            </div>
            
            <button class="btn-close" onclick="saveNotesOnly()">ðŸ’¾ SAVE NOTES & CLOSE</button>
        </div>
    </div>

    <script>
        let inspectionData = {};
        let projectInfo = "Unknown Project";
        let activeNodeData = null; // Tracks which window is open in the modal

        // --- CSV INGESTION ---
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                parseCSV(event.target.result);
            };
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const rows = text.trim().split('\n');
            inspectionData = {}; 

            for (let i = 1; i < rows.length; i++) {
                if(!rows[i]) continue;
                const cols = rows[i].replace(/"/g, '').split(',');
                
                if (cols.length >= 8) {
                    projectInfo = cols[0]; 
                    const tech = cols[2];
                    const fullId = cols[3]; 
                    const flir = cols[4];
                    const finds = cols[5];
                    const moistPct = cols[6];
                    const proved = cols[7];
                    const time = cols[8];

                    // Determine Status Color
                    let status = 'status-clear';
                    if (!finds.includes('CLEAR')) {
                        status = 'status-flagged'; // Any defect is instantly flagged Yellow
                    }

                    const parts = fullId.split('-');
                    if(parts.length === 3) {
                        const drop = parts[0];
                        const floor = parseInt(parts[1]);
                        const pos = parts[2];

                        if (!inspectionData[drop]) inspectionData[drop] = {};
                        if (!inspectionData[drop][floor]) inspectionData[drop][floor] = {};
                        
                        inspectionData[drop][floor][pos] = {
                            id: fullId, flir: flir, finds: finds, mPct: moistPct, 
                            proved: proved, tech: tech, time: time, status: status,
                            notes: "" // New field for management
                        };
                    }
                }
            }

            document.getElementById('project-name').innerText = "Project: " + projectInfo;
            document.getElementById('drop-zone').style.display = 'none';
            document.getElementById('btn-export').style.display = 'block';

            updateGridAndStats();
        }

        // --- RENDER GRID & STATS ---
        function updateGridAndStats() {
            const container = document.getElementById('building-container');
            container.innerHTML = '';

            let total = 0, flagged = 0, confirmed = 0;
            const drops = Object.keys(inspectionData).sort();

            drops.forEach(dropStr => {
                const dropDiv = document.createElement('div');
                dropDiv.className = 'drop-column';
                dropDiv.innerHTML = `<div class="drop-header">DROP ${dropStr}</div>`;

                const floors = Object.keys(inspectionData[dropStr]).map(Number);
                const maxFloor = Math.max(...floors);
                const minFloor = Math.min(...floors);

                for (let f = maxFloor; f >= minFloor; f--) {
                    const floorDiv = document.createElement('div');
                    floorDiv.className = 'floor-row';
                    floorDiv.innerHTML = `<div class="floor-label">${f}F</div>`;
                    
                    const winGroup = document.createElement('div');
                    winGroup.className = 'window-group';

                    ['L', 'C', 'R'].forEach(pos => {
                        const winNode = document.createElement('div');
                        
                        if (inspectionData[dropStr][f] && inspectionData[dropStr][f][pos]) {
                            const data = inspectionData[dropStr][f][pos];
                            winNode.className = `window-node ${data.status}`;
                            winNode.innerText = pos;
                            winNode.onclick = () => openModal(data);
                            
                            // Tally Stats
                            total++;
                            if (data.status === 'status-flagged') flagged++;
                            if (data.status === 'status-confirmed') confirmed++;
                            
                        } else {
                            winNode.className = `window-node status-empty`;
                            winNode.innerText = pos;
                        }
                        winGroup.appendChild(winNode);
                    });

                    floorDiv.appendChild(winGroup);
                    dropDiv.appendChild(floorDiv);
                }
                container.appendChild(dropDiv);
            });

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-flagged').innerText = flagged;
            document.getElementById('stat-confirmed').innerText = confirmed;
            document.getElementById('stats-bar').style.display = 'flex';
        }

        // --- MODAL & MANAGEMENT LOGIC ---
        function openModal(data) {
            activeNodeData = data; // Set the active global reference
            
            document.getElementById('m-id').innerText = data.id;
            document.getElementById('m-tech').innerText = `Logged by ${data.tech} at ${data.time}`;
            document.getElementById('m-finds').innerText = data.finds;
            document.getElementById('m-moisture').innerText = data.mPct;
            document.getElementById('m-proved').innerText = data.proved;
            document.getElementById('m-flir').innerText = data.flir;
            document.getElementById('m-notes').value = data.notes;
            
            // Only show the big RED confirm button if it's currently yellow (flagged)
            if (data.status === 'status-flagged') {
                document.getElementById('btn-confirm-issue').style.display = 'block';
            } else {
                document.getElementById('btn-confirm-issue').style.display = 'none';
            }

            document.getElementById('info-modal').style.display = 'flex';
        }

        function confirmIssue() {
            if (activeNodeData) {
                activeNodeData.notes = document.getElementById('m-notes').value;
                activeNodeData.status = 'status-confirmed'; // Change to Red
                updateGridAndStats(); // Re-draw the building to reflect the color change
                closeModal();
            }
        }

        function saveNotesOnly() {
            if (activeNodeData) {
                activeNodeData.notes = document.getElementById('m-notes').value;
                // Doesn't change color, just saves the text
                updateGridAndStats();
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('info-modal').style.display = 'none';
            activeNodeData = null;
        }

        // --- EXPORT TO REPAIR CREW ---
        function exportReviewedCSV() {
            let csv = "Project,Drop ID,FLIR Image,Findings,Moisture %,Meter Proved,Office Review Status,Management Notes\n";
            
            const drops = Object.keys(inspectionData).sort();
            drops.forEach(dropStr => {
                const floors = Object.keys(inspectionData[dropStr]).sort((a,b) => b-a); // Top down
                floors.forEach(f => {
                    ['L', 'C', 'R'].forEach(pos => {
                        if (inspectionData[dropStr][f] && inspectionData[dropStr][f][pos]) {
                            const d = inspectionData[dropStr][f][pos];
                            
                            // Convert HTML class status back to plain English for the spreadsheet
                            let textStatus = "Clear";
                            if (d.status === 'status-flagged') textStatus = "Pending Review";
                            if (d.status === 'status-confirmed') textStatus = "CONFIRMED DEFECT";

                            // Clean notes to avoid breaking CSV format
                            const cleanNotes = `"${d.notes.replace(/"/g, '""')}"`;
                            const cleanFinds = `"${d.finds}"`;

                            csv += `"${projectInfo}","${d.id}","${d.flir}",${cleanFinds},"${d.mPct}","${d.proved}","${textStatus}",${cleanNotes}\n`;
                        }
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `Strata_Reviewed_${projectInfo.replace(/\s+/g, '_')}.csv`; 
            a.click();
        }
    </script>
</body>
</html>
