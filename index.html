<!DOCTYPE html>
<html>
<head>
    <title>Strata Command Center | v5.9 Spatial Tagging</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #0f111a; color: #fff; margin: 0; padding: 20px; overflow-x: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0cf; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 900; letter-spacing: 1px; color: #fff; }
        .header span { color: #0cf; }
        
        /* --- UPLOAD ZONE --- */
        .upload-zone { background: #1a1d27; border: 2px dashed #333; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #0cf; background: #202430; }
        .upload-zone h2 { margin: 0 0 10px 0; color: #888; font-size: 1.2rem; transition: 0.3s; }
        .upload-zone.compact { padding: 15px; border-style: dotted; }
        .upload-zone.compact h2 { font-size: 1rem; margin: 0 0 5px 0; }

        /* --- MAPPING SCREEN --- */
        #mapping-screen { background: #1a1d27; border-radius: 12px; padding: 25px; border: 1px solid #333; display: none; margin-bottom: 20px; }
        .elevation-creator { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .elevation-creator input { flex: 1; padding: 12px; background: #111; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 1rem; }
        .mapping-row { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #222; }
        .mapping-row select { padding: 10px; background: #222; color: #0cf; border: 1px solid #444; border-radius: 4px; font-size: 1rem; font-weight: bold; width: 200px; }
        .mapping-row select:disabled { color: #888; border-color: #333; cursor: not-allowed; }

        /* --- DASHBOARD CONTROLS --- */
        #dashboard-screen { display: none; }
        .view-controls { display: flex; gap: 10px; margin-bottom: 20px; background: #1a1d27; padding: 10px; border-radius: 8px; border: 1px solid #333; align-items: center; }
        .view-toggle-btn { flex: 1; padding: 12px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; background: #222; color: #888; transition: 0.2s; }
        .view-toggle-btn.active { background: #0cf; color: #000; }
        
        #btn-true3d { background: #2b113d; color: #d080ff; border: 1px solid #5a2e7a; }
        #btn-true3d.active { background: #b055ff; color: #fff; }

        .stitch-mode-on { border-color: #f39c12 !important; background: rgba(243, 156, 18, 0.2) !important; color: #f39c12 !important; box-shadow: 0 0 10px rgba(243, 156, 18, 0.5); }
        .tag-mode-on { border-color: #d080ff !important; background: rgba(176, 85, 255, 0.2) !important; color: #fff !important; box-shadow: 0 0 15px rgba(176, 85, 255, 0.6) !important; }
        .node-selected { border-color: #0cf !important; transform: scale(1.1); box-shadow: 0 0 15px #0cf !important; z-index: 20 !important; }

        .tabs-container { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; border-bottom: 2px solid #333; margin-bottom: 20px; }
        .tab { padding: 12px 25px; background: #1a1d27; color: #888; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; font-size: 1rem; border: 1px solid #333; border-bottom: none; transition: 0.2s; white-space: nowrap; }
        .tab:hover { background: #202430; color: #ccc; }
        .tab.active { background: #0cf; color: #000; border-color: #0cf; }

        .stats-bar { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: #1a1d27; padding: 15px; border-radius: 8px; border-left: 4px solid #333; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .stat-value { font-size: 2rem; font-weight: 900; margin-top: 5px; }

        /* --- 2D GRID STYLES --- */
        #building-container-2d { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; align-items: flex-end; }
        .drop-column { background: #161922; border: 1px solid #2a2d38; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; min-width: max-content; }
        .drop-header { text-align: center; font-size: 1.2rem; font-weight: bold; color: #0cf; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* NEW Y-AXIS STYLES */
        .floor-axis-column { background: transparent; border: none; padding-right: 0; padding-left: 0; min-width: auto; margin-right: -5px; }
        .floor-axis-header { color: transparent; border-bottom-color: transparent; }
        
        .floor-row { display: flex; align-items: center; margin-bottom: 4px; }
        .floor-label { width: 35px; font-weight: bold; color: #888; font-size: 0.9rem; text-align: right; margin-right: 10px; height: 50px; display: flex; align-items: center; justify-content: flex-end; }
        
        .window-group { display: flex; gap: 4px; flex: 1; justify-content: center; width: 140px; } 
        .window-node { flex: 1; height: 50px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: rgba(255,255,255,0.9); border: 2px solid rgba(0,0,0,0.5); transition: transform 0.1s; position: relative; }
        .window-node:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.8); z-index: 10; }
        
        /* CSS BRIDGE CLASS */
        .stitch-bridge { position: absolute; top: -2px; bottom: -2px; right: -39px; width: 39px; z-index: -1; border-top: 2px solid rgba(0,0,0,0.5); border-bottom: 2px solid rgba(0,0,0,0.5); }

        .status-clear { background: #28a745; } 
        .status-flagged { background: #f1c40f; color: #000; } 
        .status-confirmed { background: #d9534f; } 
        .status-empty { background: #222; border: 2px dashed #444; color: #555; pointer-events: none; }
        .status-void { background: transparent; border: 2px solid transparent; cursor: default; pointer-events: none; }

        /* --- CSS 3D ARENA STYLES --- */
        #arena-3d { display: none; perspective: 1500px; width: 100%; height: 80vh; min-height: 700px; background: radial-gradient(circle, #1a1d27 0%, #0f111a 100%); border: 1px solid #333; border-radius: 12px; overflow: hidden; position: relative; cursor: grab; align-items: center; justify-content: center; margin-bottom: 20px; }
        #arena-3d:active { cursor: grabbing; }
        #world-3d { transform-style: preserve-3d; transition: transform 0.1s ease-out; display: flex; align-items: center; justify-content: center; }
        .wall-3d { position: absolute; transform-style: preserve-3d; background: rgba(15, 17, 26, 0.8); border: 2px solid #333; padding: 20px; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; gap: 15px; align-items: flex-end; }
        .wall-title-3d { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); color: #0cf; font-size: 1.5rem; font-weight: 900; white-space: nowrap; text-shadow: 0 5px 10px rgba(0,0,0,0.8); }

        /* --- TRUE 3D TWIN VIEWER --- */
        #arena-true3d { display: none; width: 100%; height: 80vh; min-height: 700px; background: radial-gradient(circle, #2a2d38 0%, #0f111a 100%); border: 1px solid #5a2e7a; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 20px; box-shadow: 0 0 30px rgba(176, 85, 255, 0.2); }
        model-viewer { width: 100%; height: 100%; outline: none; }
        
        /* 3D PIN HOTSPOTS */
        .hotspot-dot { width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.8); cursor: pointer; transform: translate(-50%, -50%); transition: transform 0.2s; }
        .hotspot-dot:hover { transform: translate(-50%, -50%) scale(1.5); }
        .hotspot-dot.status-clear { background: #28a745; box-shadow: 0 0 15px #28a745; }
        .hotspot-dot.status-flagged { background: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        .hotspot-dot.status-confirmed { background: #d9534f; box-shadow: 0 0 15px #d9534f; }
        .hotspot-label { position: absolute; background: rgba(0,0,0,0.8); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; top: -30px; left: 50%; transform: translateX(-50%); white-space: nowrap; pointer-events: none; border: 1px solid #555; }


        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-box { background: #1a1d27; border: 1px solid #0cf; border-radius: 12px; padding: 25px; width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 35px rgba(0,0,0,0.9); }
        .modal-title { font-size: 2rem; color: #0cf; margin: 0 0 5px 0; font-weight: 900; }
        .modal-subtitle { color: #888; margin-bottom: 15px; font-size: 0.9rem; }
        
        .photo-gallery { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .photo-gallery img { flex: 1; width: 100%; min-width: 200px; border-radius: 8px; border: 2px solid #333; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        .no-photo-banner { background: #222; color: #666; padding: 20px; text-align: center; border-radius: 8px; border: 1px dashed #444; margin-bottom: 15px; font-size: 0.9rem; font-weight: bold; }

        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
        .data-label { color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .data-val { font-weight: bold; text-align: right; max-width: 65%; color: #fff; }
        
        .manager-section { margin-top: 20px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .modal-notes { width: 100%; height: 80px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 10px; margin-top: 5px; font-family: inherit; resize: none; box-sizing: border-box; }
        
        .status-btns { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px; }
        .btn-status { flex: 1; padding: 10px; font-size: 0.8rem; border-radius: 4px; }
        .btn-status-yellow { background: #f1c40f; color: #000; }
        .btn-status-yellow:hover { background: #e2b607; }

        .btn { padding: 12px 20px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-blue { background: #0cf; color: #000; }
        .btn-blue:hover { background: #00aadd; }
        .btn-dark { background: #333; color: #fff; border: 1px solid #555; }
        .btn-dark:hover { background: #444; }
        .btn-red { background: #d9534f; color: #fff; }
        .btn-red:hover { background: #c9302c; }
        .btn-green { background: #28a745; color: #fff; }
        .btn-green:hover { background: #218838; }
        .btn-block { width: 100%; margin-top: 10px; }
        .header-btns { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>STRATA COMMAND <span>| v5.9 Spatial Tagging</span></h1>
            <div id="project-name" style="font-weight: bold; color: #888; margin-top: 5px;">Awaiting Data...</div>
        </div>
        <div class="header-btns">
            <button class="btn btn-dark" id="btn-reset" style="display:none;" onclick="resetBoard()">üîÑ CLEAR</button>
            <button class="btn btn-dark" id="btn-edit-map" style="display:none;" onclick="editMapping()">üó∫Ô∏è EDIT MAP</button>
            <button class="btn btn-blue" id="btn-export" style="display:none;" onclick="exportReviewedCSV()">üíæ EXPORT CSV</button>
        </div>
    </div>

    <input type="file" id="multiFileInput" multiple style="display: none;">
    <div class="upload-zone" id="drop-zone" onclick="document.getElementById('multiFileInput').click()">
        <h2 id="drop-text">üì• Drop CSVs, Photos, & 3D Models Here</h2>
        <p id="drop-subtext" style="color:#555; margin:0; font-size:0.9rem;">Accepts .csv, .jpg, .png, .glb, and .gltf files</p>
    </div>
    
    <button id="btn-start-mapping" class="btn btn-green btn-block" style="display:none; padding: 20px; font-size: 1.2rem;" onclick="openMappingScreen()">üó∫Ô∏è MAP BUILDING ELEVATIONS</button>

    <div id="mapping-screen">
        <h2 style="margin-top:0; color:#0cf;">Assign Drops to Walls</h2>
        <p style="color:#888; margin-bottom: 20px;">Create your architectural structure below. Add your custom walls, then assign drops.</p>
        
        <div class="elevation-creator">
            <input type="text" id="new-elevation-name" placeholder="e.g. North Face, Courtyard, Penthouse...">
            <button class="btn btn-blue" onclick="addElevation()">‚ûï ADD WALL</button>
        </div>
        <div id="mapping-list"></div>
        <button class="btn btn-green btn-block" style="padding: 20px; font-size: 1.2rem; margin-top: 20px;" onclick="generateDashboard()">‚úÖ GENERATE DASHBOARD</button>
    </div>

    <div id="dashboard-screen">
        
        <div class="view-controls">
            <span style="color:#888; font-weight:bold; font-size:0.9rem; margin-right: 10px;">MODE:</span>
            <button class="view-toggle-btn active" id="btn-2d" onclick="switchView('2d')">2D TABS</button>
            <button class="view-toggle-btn" id="btn-3d" onclick="switchView('3d')">CSS 3D ORBIT</button>
            <button class="view-toggle-btn" id="btn-true3d" onclick="switchView('true3d')">‚ú® TRUE 3D TWIN</button>
            <div style="flex:0.2;"></div>
            <button class="view-toggle-btn" style="border:1px solid #555;" id="btn-stitch" onclick="toggleStitchMode()">üîó STITCH 2D/3D WIDE WINDOWS</button>
            
            <button class="view-toggle-btn" style="border:1px solid #d080ff; display:none;" id="btn-tag3d" onclick="toggleTaggingMode()">üìç TAG 3D WINDOW</button>
        </div>

        <div class="stats-bar" id="stats-bar">
            <div class="stat-card" style="border-color:#28a745;">
                <div class="stat-label">Total Windows</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card" style="border-color:#f1c40f;">
                <div class="stat-label">Pending Review</div>
                <div class="stat-value" id="stat-flagged" style="color:#f1c40f;">0</div>
            </div>
            <div class="stat-card" style="border-color:#d9534f;">
                <div class="stat-label">Confirmed Defects</div>
                <div class="stat-value" id="stat-confirmed" style="color:#d9534f;">0</div>
            </div>
            <div class="stat-card" style="border-color:#0cf;">
                <div class="stat-label">Images Linked</div>
                <div class="stat-value" id="stat-photos" style="color:#0cf;">0</div>
            </div>
        </div>

        <div id="view-2d">
            <div class="tabs-container" id="tabs-container"></div>
            <div id="building-container-2d"></div>
        </div>

        <div id="arena-3d">
            
            <div style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; border: 1px solid #0cf; z-index: 100; text-align: right;">
                <label style="color:#0cf; font-weight:bold; font-size:0.8rem; margin-bottom:8px; display:block; letter-spacing: 1px;">‚ÜîÔ∏è ADJUST WALL SPACING</label>
                <input type="range" id="wallSpacingSlider" min="0" max="1500" value="500" style="width: 200px; cursor: pointer;" oninput="updateManualSpacing(this.value)">
            </div>

            <div id="world-3d"></div>
            
            <div style="position: absolute; bottom: 15px; right: 15px; color: #888; font-size: 0.8rem; font-weight: bold; background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 20px; display: flex; gap: 15px; pointer-events: none;">
                <span>üñ±Ô∏è Click & Drag to Spin</span>
                <span style="color:#0cf;">üñ±Ô∏è Scroll to Zoom</span>
            </div>
        </div>

        <div id="arena-true3d">
            <model-viewer id="main-3d-viewer"
                src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/LittlestTokyo.glb" 
                alt="A 3D model of a building" 
                auto-rotate 
                camera-controls 
                tone-mapping="neutral" 
                shadow-intensity="1">
            </model-viewer>
            <div style="position: absolute; top: 15px; left: 15px; color: #fff; font-size: 0.9rem; font-weight: bold; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; border: 1px solid #d080ff; pointer-events:none;">
                <strong>Drone Photogrammetry Engine</strong><br>
                <span id="model-status" style="font-weight:normal; color:#ccc;">Showing Default Test Model. Drop a custom .glb file above to replace.</span>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-box">
            <h2 class="modal-title" id="m-id">A-12-L</h2>
            <div class="modal-subtitle" id="m-tech">Logged by Tech at 14:30</div>
            
            <button class="btn btn-dark btn-block" id="btn-unmerge" style="display:none; margin-bottom:15px; border-color:#f39c12; color:#f39c12;" onclick="unmergeCurrent()">‚úÇÔ∏è UN-STITCH THESE WINDOWS</button>
            
            <div class="photo-gallery" id="m-photo-gallery"></div>
            <div id="m-no-photo" class="no-photo-banner">IMAGE NOT UPLOADED TO DASHBOARD</div>
            
            <div class="data-row"><span class="data-label">Field Findings</span><span class="data-val" id="m-finds" style="color:#f1c40f;">--</span></div>
            <div class="data-row"><span class="data-label">Moisture %</span><span class="data-val" id="m-moisture">--</span></div>
            <div class="data-row"><span class="data-label">Meter Proved</span><span class="data-val" id="m-proved">--</span></div>
            <div class="data-row"><span class="data-label">FLIR Image(s)</span><span class="data-val" id="m-flir" style="color:#0cf;">--</span></div>
            
            <div class="manager-section">
                <span class="data-label" style="color:#fff;">Management Notes</span>
                <textarea id="m-notes" class="modal-notes" placeholder="e.g. Schedule sealant replacement..."></textarea>
                
                <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                    <span class="data-label" style="color:#888;">Office Override: Status</span>
                    <div class="status-btns">
                        <button class="btn btn-status btn-green" onclick="changeStatus('status-clear')">‚úÖ MARK CLEAR</button>
                        <button class="btn btn-status btn-status-yellow" onclick="changeStatus('status-flagged')">‚ö†Ô∏è FLAG (REVIEW)</button>
                        <button class="btn btn-status btn-red" onclick="changeStatus('status-confirmed')">üö® CONFIRM DEFECT</button>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-dark btn-block" onclick="saveNotesOnly()">üíæ SAVE NOTES & CLOSE</button>
        </div>
    </div>

    <div class="modal-overlay" id="tagging-modal">
        <div class="modal-box" style="border-color:#d080ff;">
            <h2 style="color:#d080ff; margin-top:0; font-size: 1.8rem;">üìç PIN WINDOW TO 3D MODEL</h2>
            <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Select which logged window you just clicked on:</p>
            
            <select id="tagging-window-select" style="width:100%; padding:15px; background:#222; color:#fff; border:1px solid #555; border-radius:8px; font-size:1.1rem; font-weight:bold; margin-bottom:20px;">
                </select>
            
            <button class="btn btn-green btn-block" onclick="confirm3DTag()">‚úÖ DROP PIN</button>
            <button class="btn btn-dark btn-block" onclick="cancel3DTag()">üîô CANCEL</button>
        </div>
    </div>

    <script>
        let inspectionData = {};
        let projectInfo = "Unknown Project";
        
        let activeNodeDataArray = []; 
        let isStitchMode = false;
        let stitchSelection = [];
        let stitchedPairs = []; 
        
        let imageBank = {}; 
        let linkedPhotosCount = 0;

        let elevations = []; 
        let dropAssignments = {}; 
        let activeTab = "";
        let globalStats = { t:0, f:0, c:0, maxFloor: -Infinity, minFloor: Infinity };

        let currentMode = '2d'; 
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let rotationY = -30; 
        let rotationX = 5;   
        let zoomZ = -400; 

        let manualRadiusOffset = null;

        // --- 3D TAGGING VARIABLES ---
        let isTaggingMode = false;
        let pendingTagCoordinates = null;
        let saved3DTags = {}; // Stores { windowId: { position: "x y z", normal: "x y z" } }

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('multiFileInput');
        const viewer = document.querySelector('#main-3d-viewer');

        dropZone.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            dropZone.classList.add('dragover'); 
        });
        
        dropZone.addEventListener('dragleave', (e) => { 
            e.preventDefault(); 
            dropZone.classList.remove('dragover'); 
        });
        
        dropZone.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            dropZone.classList.remove('dragover'); 
            handleFiles(e.dataTransfer.files); 
        });
        
        fileInput.addEventListener('change', (e) => { 
            handleFiles(e.target.files); 
        });

        async function handleFiles(files) {
            if (!files || files.length === 0) return;
            const csvPromises = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.type.startsWith('image/')) {
                    const cleanName = file.name.split('.')[0].toUpperCase();
                    imageBank[cleanName] = URL.createObjectURL(file);
                    linkedPhotosCount++;
                } 
                else if (file.name.toLowerCase().endsWith('.glb') || file.name.toLowerCase().endsWith('.gltf')) {
                    const modelUrl = URL.createObjectURL(file);
                    viewer.src = modelUrl;
                    document.getElementById('model-status').innerHTML = `<span style="color:#0cf;">Loaded Custom Model:</span> ${file.name}`;
                }
                else if (file.name.toLowerCase().endsWith('.csv')) {
                    csvPromises.push(new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (event) => { 
                            parseCSV(event.target.result); 
                            resolve(); 
                        };
                        reader.readAsText(file);
                    }));
                }
            }

            await Promise.all(csvPromises);

            document.getElementById('project-name').innerText = "Project: " + projectInfo;
            document.getElementById('stat-photos').innerText = linkedPhotosCount;
            
            dropZone.classList.add('compact');
            document.getElementById('drop-text').innerText = "‚ûï Add More Files";
            document.getElementById('drop-subtext').innerText = "Drop CSVs, Photos, or a 3D Model here";
            
            document.getElementById('btn-reset').style.display = 'inline-block';
            document.getElementById('btn-start-mapping').style.display = 'block';
            
            if (document.getElementById('dashboard-screen').style.display === 'block') {
                calculateBuildingGeometry();
                if (currentMode !== 'true3d') refreshCurrentView();
            }
            fileInput.value = "";
        }

        function parseCSV(text) {
            const rows = text.trim().split('\n');
            for (let i = 1; i < rows.length; i++) {
                if(!rows[i]) continue;
                const cols = rows[i].replace(/"/g, '').split(',');
                
                if (cols.length >= 8) {
                    if (projectInfo === "Unknown Project") projectInfo = cols[0];
                    const tech = cols[2];
                    const fullId = cols[3]; 
                    const flir = cols[4];
                    const finds = cols[5];
                    const moistPct = cols[6];
                    const proved = cols[7];
                    const time = cols[8];

                    let status = 'status-clear';
                    if (!finds.includes('CLEAR')) status = 'status-flagged'; 

                    const parts = fullId.split('-');
                    if(parts.length === 3) {
                        const drop = parts[0];
                        const floor = parseInt(parts[1]);
                        const pos = parts[2];

                        if (!inspectionData[drop]) inspectionData[drop] = {};
                        if (!inspectionData[drop][floor]) inspectionData[drop][floor] = {};
                        
                        let existingNotes = "";
                        let existingStatus = status;
                        if(inspectionData[drop][floor][pos]) {
                            existingNotes = inspectionData[drop][floor][pos].notes;
                            if(inspectionData[drop][floor][pos].status === 'status-confirmed') existingStatus = 'status-confirmed';
                            if(inspectionData[drop][floor][pos].status === 'status-clear') existingStatus = 'status-clear';
                            if(inspectionData[drop][floor][pos].status === 'status-flagged') existingStatus = 'status-flagged';
                        }

                        inspectionData[drop][floor][pos] = {
                            id: fullId, flir: flir, finds: finds, mPct: moistPct, 
                            proved: proved, tech: tech, time: time, status: existingStatus,
                            notes: existingNotes
                        };
                        
                        if(!dropAssignments[drop]) dropAssignments[drop] = "";
                    }
                }
            }
        }

        // --- 3D TAGGING LOGIC ---
        function toggleTaggingMode() {
            isTaggingMode = !isTaggingMode;
            const btn = document.getElementById('btn-tag3d');
            btn.classList.toggle('tag-mode-on', isTaggingMode);
            
            if(isTaggingMode) {
                alert("üìç TAGGING MODE ACTIVE:\nDouble-click anywhere on the 3D model to pin a logged window to that exact physical location.");
                viewer.autoRotate = false; // Stop spinning while trying to click
            } else {
                viewer.autoRotate = true;
            }
        }

        // Catch double-clicks on the 3D model
        viewer.addEventListener('dblclick', (event) => {
            if (!isTaggingMode) return;
            
            const rect = viewer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Extract exact 3D coordinate from the 2D click
            const hit = viewer.positionAndNormalFromPoint(x, y);
            
            if (hit != null) {
                pendingTagCoordinates = hit;
                populateTaggingDropdown();
                document.getElementById('tagging-modal').style.display = 'flex';
            }
        });

        function populateTaggingDropdown() {
            const select = document.getElementById('tagging-window-select');
            select.innerHTML = "";
            
            let allIds = [];
            Object.keys(inspectionData).forEach(dropStr => {
                Object.keys(inspectionData[dropStr]).forEach(floorNum => {
                    Object.keys(inspectionData[dropStr][floorNum]).forEach(pos => {
                        allIds.push(inspectionData[dropStr][floorNum][pos]);
                    });
                });
            });
            
            // Sort by defect status first (to easily find leaks), then alphabetically
            allIds.sort((a, b) => {
                if(a.status !== b.status) return a.status === 'status-clear' ? 1 : -1;
                return a.id.localeCompare(b.id);
            });
            
            allIds.forEach(data => {
                const opt = document.createElement('option');
                opt.value = data.id;
                let symbol = data.status === 'status-clear' ? '‚úÖ' : (data.status === 'status-confirmed' ? 'üö®' : '‚ö†Ô∏è');
                opt.innerText = `${symbol} ${data.id} (${data.finds.split('|')[0]})`;
                select.appendChild(opt);
            });
        }

        function cancel3DTag() {
            document.getElementById('tagging-modal').style.display = 'none';
            pendingTagCoordinates = null;
        }

        function confirm3DTag() {
            const selectedId = document.getElementById('tagging-window-select').value;
            
            saved3DTags[selectedId] = {
                position: pendingTagCoordinates.position.toString(),
                normal: pendingTagCoordinates.normal.toString()
            };
            
            document.getElementById('tagging-modal').style.display = 'none';
            pendingTagCoordinates = null;
            
            // Turn off tagging mode automatically after a successful drop
            isTaggingMode = false;
            document.getElementById('btn-tag3d').classList.remove('tag-mode-on');
            viewer.autoRotate = true;
            
            render3DHotspots();
        }

        function render3DHotspots() {
            // Clear existing hotspots
            viewer.querySelectorAll('.hotspot-dot').forEach(el => el.remove());
            
            Object.keys(saved3DTags).forEach(id => {
                const data = getNodeData(id);
                if(!data) return;
                
                const btn = document.createElement('button');
                btn.slot = `hotspot-${id}`;
                btn.dataset.position = saved3DTags[id].position;
                btn.dataset.normal = saved3DTags[id].normal;
                
                // Determine final status (checking if stitched)
                let finalStatus = data.status;
                let pair = stitchedPairs.find(p => p.includes(data.id));
                if(pair) finalStatus = getCombinedStatus(pair[0], pair[1]);
                
                btn.className = `hotspot-dot ${finalStatus}`;
                btn.onclick = () => openModal(id);
                
                const label = document.createElement('div');
                label.className = 'hotspot-label';
                label.innerText = id;
                btn.appendChild(label);
                
                viewer.appendChild(btn);
            });
        }
        // --- END 3D TAGGING LOGIC ---

        function toggleStitchMode() {
            isStitchMode = !isStitchMode;
            document.getElementById('btn-stitch').classList.toggle('stitch-mode-on', isStitchMode);
            stitchSelection = [];
            if(isStitchMode) {
                alert("STITCH MODE ACTIVE:\nClick the right half of the window, then click the left half. The system will merge them.");
            }
            if (currentMode !== 'true3d') refreshCurrentView();
        }

        function getNodeData(fullId) {
            const parts = fullId.split('-');
            if(inspectionData[parts[0]] && inspectionData[parts[0]][parts[1]]) {
                return inspectionData[parts[0]][parts[1]][parts[2]];
            }
            return null;
        }

        function getCombinedStatus(id1, id2) {
            let d1 = getNodeData(id1);
            let d2 = getNodeData(id2);
            if(!d1 || !d2) return 'status-clear';
            if(d1.status === 'status-confirmed' || d2.status === 'status-confirmed') return 'status-confirmed';
            if(d1.status === 'status-flagged' || d2.status === 'status-flagged') return 'status-flagged';
            return 'status-clear';
        }

        function handleNodeClick(data, nodeElement) {
            if(isStitchMode) {
                let existingPairIndex = stitchedPairs.findIndex(p => p.includes(data.id));
                if (existingPairIndex !== -1) {
                    if(confirm("This window is already stitched. Do you want to un-stitch it?")) {
                        stitchedPairs.splice(existingPairIndex, 1);
                        stitchSelection = [];
                        isStitchMode = false;
                        document.getElementById('btn-stitch').classList.remove('stitch-mode-on');
                        calculateBuildingGeometry();
                        refreshCurrentView();
                    }
                    return;
                }
                
                stitchSelection.push(data.id);
                nodeElement.classList.add('node-selected');
                
                if(stitchSelection.length === 2) {
                    stitchSelection.sort(); 
                    stitchedPairs.push([...stitchSelection]);
                    isStitchMode = false;
                    document.getElementById('btn-stitch').classList.remove('stitch-mode-on');
                    stitchSelection = [];
                    refreshCurrentView();
                }
                return;
            }
            openModal(data.id);
        }

        function openMappingScreen() {
            document.getElementById('btn-start-mapping').style.display = 'none';
            document.getElementById('mapping-screen').style.display = 'block';
            renderMappingList();
        }

        function editMapping() {
            document.getElementById('dashboard-screen').style.display = 'none';
            document.getElementById('mapping-screen').style.display = 'block';
            document.getElementById('btn-export').style.display = 'none';
            document.getElementById('btn-edit-map').style.display = 'none';
            renderMappingList();
        }

        function addElevation() {
            const input = document.getElementById('new-elevation-name');
            const val = input.value.trim();
            if(val && !elevations.includes(val)) {
                elevations.push(val);
                
                if (elevations.length === 1) {
                    activeTab = val;
                    Object.keys(dropAssignments).forEach(d => {
                        if (dropAssignments[d] === "") dropAssignments[d] = val;
                    });
                }
                
                input.value = "";
                renderMappingList();
            }
        }

        function renderMappingList() {
            const list = document.getElementById('mapping-list');
            list.innerHTML = "";
            const drops = Object.keys(inspectionData).sort();

            if (elevations.length === 0 && drops.length > 0) {
                const warning = document.createElement('div');
                warning.style = "color: #f1c40f; margin-bottom: 15px; font-weight: bold;";
                warning.innerText = "‚ö†Ô∏è Please add at least one wall above to map your drops.";
                list.appendChild(warning);
            }

            drops.forEach(dropStr => {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                row.innerHTML = `<strong style="font-size:1.2rem; color:#0cf;">DROP ${dropStr}</strong>`;
                
                const select = document.createElement('select');
                select.onchange = (e) => { dropAssignments[dropStr] = e.target.value; };
                
                if (elevations.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = "";
                    opt.innerText = "Awaiting Wall...";
                    select.appendChild(opt);
                    select.disabled = true;
                } else {
                    select.disabled = false;
                    elevations.forEach(elev => {
                        const opt = document.createElement('option');
                        opt.value = elev;
                        opt.innerText = elev;
                        if(dropAssignments[dropStr] === elev) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
                
                row.appendChild(select);
                list.appendChild(row);
            });
        }

        function generateDashboard() {
            if (elevations.length === 0) {
                alert("‚ö†Ô∏è You must add at least one custom wall before generating the dashboard.");
                return;
            }
            
            document.getElementById('mapping-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            document.getElementById('btn-export').style.display = 'inline-block';
            document.getElementById('btn-edit-map').style.display = 'inline-block';
            
            if(!elevations.includes(activeTab)) activeTab = elevations[0];
            
            calculateBuildingGeometry();
            if (currentMode !== 'true3d') refreshCurrentView();
        }

        function calculateBuildingGeometry() {
            globalStats = { t:0, f:0, c:0, maxFloor: -Infinity, minFloor: Infinity };
            const drops = Object.keys(inspectionData);
            
            drops.forEach(dropStr => {
                const floors = Object.keys(inspectionData[dropStr]).map(Number);
                floors.forEach(f => {
                    if (f > globalStats.maxFloor) globalStats.maxFloor = f;
                    if (f < globalStats.minFloor) globalStats.minFloor = f;

                    Object.keys(inspectionData[dropStr][f]).forEach(pos => {
                        const d = inspectionData[dropStr][f][pos];
                        globalStats.t++;
                        if (d.status === 'status-flagged') globalStats.f++;
                        if (d.status === 'status-confirmed') globalStats.c++;
                    });
                });
            });

            if (globalStats.maxFloor === -Infinity) {
                globalStats.maxFloor = 0;
                globalStats.minFloor = 0;
            }
            
            stitchedPairs.forEach(pair => {
                let d1 = getNodeData(pair[0]); 
                let d2 = getNodeData(pair[1]);
                if (d1 && d2) {
                    if(d1.status === 'status-flagged' && d2.status === 'status-flagged') globalStats.f--;
                    if(d1.status === 'status-confirmed' && d2.status === 'status-confirmed') globalStats.c--;
                }
            });
            
            updateStatsUI();
            
            // Re-render 3D tags if their status changed
            render3DHotspots();
        }

        function updateStatsUI() {
            document.getElementById('stat-total').innerText = globalStats.t;
            document.getElementById('stat-flagged').innerText = globalStats.f;
            document.getElementById('stat-confirmed').innerText = globalStats.c;
        }

        function switchView(mode) {
            currentMode = mode;
            document.getElementById('btn-2d').classList.toggle('active', mode === '2d');
            document.getElementById('btn-3d').classList.toggle('active', mode === '3d');
            document.getElementById('btn-true3d').classList.toggle('active', mode === 'true3d');
            
            // Show Tagging button only in True 3D mode
            document.getElementById('btn-tag3d').style.display = (mode === 'true3d') ? 'inline-block' : 'none';
            
            document.getElementById('view-2d').style.display = (mode === '2d') ? 'block' : 'none';
            document.getElementById('arena-3d').style.display = (mode === '3d') ? 'flex' : 'none';
            document.getElementById('arena-true3d').style.display = (mode === 'true3d') ? 'block' : 'none';

            if (mode !== 'true3d') {
                refreshCurrentView();
            }
        }

        function updateManualSpacing(val) {
            manualRadiusOffset = parseInt(val, 10);
            if (currentMode === '3d') {
                render3DArena();
            }
        }

        function refreshCurrentView() {
            if (currentMode === '2d') {
                renderTabs();
                render2DGrid();
            } else if (currentMode === '3d') {
                render3DArena();
            }
        }

        function generateWallDOM(elevationName, useGlobalFloors = false) {
            const fragment = document.createDocumentFragment();
            const activeDrops = Object.keys(inspectionData).filter(d => dropAssignments[d] === elevationName).sort();

            if(activeDrops.length === 0) {
                const empty = document.createElement('div');
                empty.style = "padding: 40px; color:#888; width:100%; text-align:center;";
                empty.innerText = "No drops assigned.";
                fragment.appendChild(empty);
                return fragment;
            }

            let renderMaxFloor = -Infinity;
            let renderMinFloor = Infinity;
            
            if (useGlobalFloors) {
                renderMaxFloor = globalStats.maxFloor;
                renderMinFloor = globalStats.minFloor;
            } else {
                activeDrops.forEach(d => {
                    const floors = Object.keys(inspectionData[d]).map(Number);
                    renderMaxFloor = Math.max(renderMaxFloor, ...floors);
                    renderMinFloor = Math.min(renderMinFloor, ...floors);
                });
            }

            // --- Y-AXIS FLOOR COLUMN ---
            const axisCol = document.createElement('div');
            axisCol.className = 'drop-column floor-axis-column';
            
            const axisHeader = document.createElement('div');
            axisHeader.className = 'drop-header floor-axis-header';
            axisHeader.innerText = 'FL';
            axisCol.appendChild(axisHeader);

            for (let f = renderMaxFloor; f >= renderMinFloor; f--) {
                const fRow = document.createElement('div');
                fRow.className = 'floor-row';
                fRow.innerHTML = `<div class="floor-label">${f}F</div>`;
                axisCol.appendChild(fRow);
            }
            fragment.appendChild(axisCol);
            
            // --- DROP COLUMNS ---
            activeDrops.forEach(dropStr => {
                const dropDiv = document.createElement('div');
                dropDiv.className = 'drop-column';
                dropDiv.innerHTML = `<div class="drop-header">DROP ${dropStr}</div>`;

                for (let f = renderMaxFloor; f >= renderMinFloor; f--) {
                    const floorDiv = document.createElement('div');
                    floorDiv.className = 'floor-row';
                    
                    const winGroup = document.createElement('div');
                    winGroup.className = 'window-group';

                    if (inspectionData[dropStr] && inspectionData[dropStr][f]) {
                        const order = { 'L': 1, 'C': 2, 'R': 3 };
                        const activeFloorPattern = Object.keys(inspectionData[dropStr][f]).sort((a, b) => order[a] - order[b]);
                        
                        activeFloorPattern.forEach(pos => {
                            const data = inspectionData[dropStr][f][pos];
                            const winNode = document.createElement('div');
                            
                            let isStitchedLeft = false;
                            let isStitchedRight = false;
                            let finalStatus = data.status;

                            let pair = stitchedPairs.find(p => p.includes(data.id));
                            if (pair) {
                                finalStatus = getCombinedStatus(pair[0], pair[1]);
                                if (pair[0] === data.id) isStitchedLeft = true;
                                if (pair[1] === data.id) isStitchedRight = true;
                            }

                            winNode.className = `window-node ${finalStatus}`;
                            winNode.innerText = pos;
                            winNode.onclick = () => handleNodeClick(data, winNode);
                            
                            if (imageBank[data.flir]) winNode.style.border = "2px solid #fff";

                            if (isStitchedLeft) {
                                winNode.style.borderTopRightRadius = '0';
                                winNode.style.borderBottomRightRadius = '0';
                                winNode.style.borderRight = "none";
                                winNode.style.zIndex = '5';
                                
                                const bridge = document.createElement('div');
                                bridge.className = `stitch-bridge ${finalStatus}`;
                                
                                if (imageBank[data.flir]) {
                                    winNode.style.borderRight = "none";
                                    bridge.style.borderTop = "2px solid #fff";
                                    bridge.style.borderBottom = "2px solid #fff";
                                }
                                winNode.appendChild(bridge);
                            }
                            if (isStitchedRight) {
                                winNode.style.borderTopLeftRadius = '0';
                                winNode.style.borderBottomLeftRadius = '0';
                                winNode.style.borderLeft = "none";
                                winNode.style.zIndex = '6'; 
                                if (imageBank[data.flir]) {
                                    winNode.style.borderLeft = "none";
                                }
                            }
                            
                            winGroup.appendChild(winNode);
                        });
                    } else {
                        const winNode = document.createElement('div');
                        winNode.className = `window-node status-void`;
                        winGroup.appendChild(winNode);
                    }

                    floorDiv.appendChild(winGroup);
                    dropDiv.appendChild(floorDiv);
                }
                fragment.appendChild(dropDiv);
            });
            return fragment;
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = "";
            const usedElevations = new Set(Object.values(dropAssignments));
            
            elevations.forEach(elev => {
                if(usedElevations.has(elev)) {
                    const tab = document.createElement('div');
                    tab.className = `tab ${activeTab === elev ? 'active' : ''}`;
                    tab.innerText = elev;
                    tab.onclick = () => { activeTab = elev; renderTabs(); render2DGrid(); };
                    container.appendChild(tab);
                }
            });
            if(!usedElevations.has(activeTab) && usedElevations.size > 0) {
                activeTab = Array.from(usedElevations)[0];
                renderTabs();
                render2DGrid();
            }
        }

        function render2DGrid() {
            const container = document.getElementById('building-container-2d');
            container.innerHTML = '';
            container.appendChild(generateWallDOM(activeTab, false));
        }

        function render3DArena() {
            const world = document.getElementById('world-3d');
            world.innerHTML = '';
            world.style.transform = `translateZ(${zoomZ}px) rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;

            const usedElevations = Array.from(new Set(Object.values(dropAssignments)));
            const numWalls = usedElevations.length;
            
            if (numWalls === 0) return;
            const angleStep = 360 / numWalls;
            
            let maxDropsOnAWall = 0;
            usedElevations.forEach(elev => {
                const dropsOnThisWall = Object.keys(inspectionData).filter(d => dropAssignments[d] === elev).length;
                if(dropsOnThisWall > maxDropsOnAWall) maxDropsOnAWall = dropsOnThisWall;
            });
            
            const estimatedMaxWidth = Math.max(300, (maxDropsOnAWall * 170) + 100);

            let radius = 0;
            if (manualRadiusOffset !== null) {
                radius = manualRadiusOffset;
            } else {
                if (numWalls === 1) {
                    radius = 0;
                } else if (numWalls === 2) {
                    radius = estimatedMaxWidth / 2 + 50; 
                } else {
                    radius = (estimatedMaxWidth / 2) / Math.tan(Math.PI / numWalls);
                    radius += 100; 
                }
                const slider = document.getElementById('wallSpacingSlider');
                if(slider) slider.value = Math.round(radius);
            }

            usedElevations.forEach((elev, index) => {
                const wallDiv = document.createElement('div');
                wallDiv.className = 'wall-3d';
                wallDiv.innerHTML = `<div class="wall-title-3d">${elev}</div>`;
                
                wallDiv.appendChild(generateWallDOM(elev, true));
                
                wallDiv.style.transform = `rotateY(${index * angleStep}deg) translateZ(${radius}px)`;
                world.appendChild(wallDiv);
            });
        }

        const arena = document.getElementById('arena-3d');
        
        arena.addEventListener('wheel', (e) => {
            if(currentMode === '3d') {
                e.preventDefault();
                zoomZ -= e.deltaY * 2; 
                document.getElementById('world-3d').style.transform = `translateZ(${zoomZ}px) rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
            }
        }, { passive: false }); 

        arena.addEventListener('mousedown', (e) => { isDragging = true; previousMousePosition = { x: e.clientX, y: e.clientY }; });
        window.addEventListener('mousemove', (e) => {
            if (isDragging && currentMode === '3d') {
                rotationY += (e.clientX - previousMousePosition.x) * 0.4; 
                rotationX -= (e.clientY - previousMousePosition.y) * 0.4; 
                if(rotationX > 45) rotationX = 45;
                if(rotationX < -45) rotationX = -45;
                document.getElementById('world-3d').style.transform = `translateZ(${zoomZ}px) rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });
        window.addEventListener('mouseup', () => { isDragging = false; });
        
        arena.addEventListener('touchstart', (e) => { isDragging = true; previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY }; }, {passive: true});
        window.addEventListener('touchmove', (e) => {
            if (isDragging && currentMode === '3d') {
                rotationY += (e.touches[0].clientX - previousMousePosition.x) * 0.5;
                rotationX -= (e.touches[0].clientY - previousMousePosition.y) * 0.5;
                if(rotationX > 45) rotationX = 45;
                if(rotationX < -45) rotationX = -45;
                document.getElementById('world-3d').style.transform = `translateZ(${zoomZ}px) rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }, {passive: true});
        window.addEventListener('touchend', () => { isDragging = false; });

        function openModal(nodeId) {
            let pair = stitchedPairs.find(p => p.includes(nodeId));
            activeNodeDataArray = [];
            
            if (pair) {
                activeNodeDataArray.push(getNodeData(pair[0]));
                activeNodeDataArray.push(getNodeData(pair[1]));
                document.getElementById('btn-unmerge').style.display = 'block';
            } else {
                activeNodeDataArray.push(getNodeData(nodeId));
                document.getElementById('btn-unmerge').style.display = 'none';
            }

            let ids = activeNodeDataArray.map(d => d.id).join(' + ');
            let techs = [...new Set(activeNodeDataArray.map(d => d.tech))].join(', ');
            
            let allFinds = [];
            activeNodeDataArray.forEach(d => allFinds.push(...d.finds.split(' | ')));
            allFinds = [...new Set(allFinds)].filter(f => f !== 'CLEAR' && f !== '');
            if(allFinds.length === 0) allFinds = ['CLEAR'];

            let mPcts = activeNodeDataArray.map(d => d.mPct).filter(m => m !== '--').join(' & ') || '--';
            let proved = activeNodeDataArray.some(d => d.proved === 'YES') ? 'YES' : 'NO';
            let flirs = activeNodeDataArray.map(d => d.flir).filter(f => f !== '--');
            
            let notes = activeNodeDataArray.map(d => d.notes).filter(n => n.trim() !== '').join('\n');

            document.getElementById('m-id').innerText = ids;
            document.getElementById('m-tech').innerText = `Logged by: ${techs}`;
            document.getElementById('m-finds').innerText = allFinds.join(' | ');
            document.getElementById('m-finds').style.color = allFinds.includes('CLEAR') ? '#28a745' : '#f1c40f';
            
            document.getElementById('m-moisture').innerText = mPcts;
            document.getElementById('m-proved').innerText = proved;
            document.getElementById('m-flir').innerText = flirs.join(' & ') || '--';
            document.getElementById('m-notes').value = notes;
            
            const gallery = document.getElementById('m-photo-gallery');
            const noPhoto = document.getElementById('m-no-photo');
            gallery.innerHTML = '';
            let hasPhoto = false;

            flirs.forEach(f => {
                if(imageBank[f]) {
                    hasPhoto = true;
                    let img = document.createElement('img');
                    img.src = imageBank[f];
                    gallery.appendChild(img);
                }
            });

            gallery.style.display = hasPhoto ? 'flex' : 'none';
            noPhoto.style.display = hasPhoto ? 'none' : 'block';
            
            document.getElementById('info-modal').style.display = 'flex';
        }

        function unmergeCurrent() {
            if (activeNodeDataArray.length === 2) {
                const id1 = activeNodeDataArray[0].id;
                const idx = stitchedPairs.findIndex(p => p.includes(id1));
                if (idx !== -1) {
                    stitchedPairs.splice(idx, 1);
                    closeModal();
                    calculateBuildingGeometry();
                    refreshCurrentView();
                }
            }
        }

        function changeStatus(newStatus) {
            if (activeNodeDataArray.length > 0) {
                let note = document.getElementById('m-notes').value;
                activeNodeDataArray.forEach(d => {
                    d.notes = note; 
                    d.status = newStatus; 
                });
                calculateBuildingGeometry();
                refreshCurrentView();
                closeModal();
            }
        }

        function saveNotesOnly() {
            if (activeNodeDataArray.length > 0) {
                let note = document.getElementById('m-notes').value;
                activeNodeDataArray.forEach(d => {
                    d.notes = note;
                });
                calculateBuildingGeometry();
                refreshCurrentView();
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('info-modal').style.display = 'none';
            activeNodeDataArray = [];
        }

        function resetBoard() {
            if(confirm("Are you sure you want to clear all data and start over?")) {
                inspectionData = {};
                imageBank = {};
                stitchedPairs = [];
                linkedPhotosCount = 0;
                projectInfo = "Unknown Project";
                elevations = [];
                dropAssignments = {};
                manualRadiusOffset = null;
                saved3DTags = {};
                
                document.getElementById('project-name').innerText = "Awaiting Data...";
                document.getElementById('stat-photos').innerText = "0";
                document.getElementById('dashboard-screen').style.display = 'none';
                document.getElementById('mapping-screen').style.display = 'none';
                document.getElementById('btn-export').style.display = 'none';
                document.getElementById('btn-edit-map').style.display = 'none';
                document.getElementById('btn-reset').style.display = 'none';
                document.getElementById('btn-start-mapping').style.display = 'none';
                
                document.getElementById('main-3d-viewer').src = "https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/LittlestTokyo.glb";
                document.getElementById('model-status').innerHTML = "Showing Default Test Model. Drop a custom .glb file above to replace.";
                
                dropZone.classList.remove('compact');
                document.getElementById('drop-text').innerText = "üì• Drop CSVs, Photos, & 3D Models Here";
                document.getElementById('drop-subtext').innerText = "Accepts .csv, .jpg, .png, .glb, and .gltf files";
            }
        }

        function exportReviewedCSV() {
            let csv = "Project,Architectural Wall,Drop ID,FLIR Image,Findings,Moisture %,Meter Proved,Office Review Status,Management Notes\n";
            
            const drops = Object.keys(inspectionData).sort();
            drops.forEach(dropStr => {
                const wall = dropAssignments[dropStr];
                const floors = Object.keys(inspectionData[dropStr]).sort((a,b) => b-a); 
                floors.forEach(f => {
                    const order = { 'L': 1, 'C': 2, 'R': 3 };
                    const activeFloorPattern = Object.keys(inspectionData[dropStr][f]).sort((a, b) => order[a] - order[b]);
                    
                    activeFloorPattern.forEach(pos => {
                        if (inspectionData[dropStr][f] && inspectionData[dropStr][f][pos]) {
                            const d = inspectionData[dropStr][f][pos];
                            
                            let textStatus = "Clear";
                            if (d.status === 'status-flagged') textStatus = "Pending Review";
                            if (d.status === 'status-confirmed') textStatus = "CONFIRMED DEFECT";

                            const cleanNotes = `"${d.notes.replace(/"/g, '""')}"`;
                            const cleanFinds = `"${d.finds}"`;

                            csv += `"${projectInfo}","${wall}","${d.id}","${d.flir}",${cleanFinds},"${d.mPct}","${d.proved}","${textStatus}",${cleanNotes}\n`;
                        }
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `Strata_Master_Review_${projectInfo.replace(/\s+/g, '_')}.csv`; 
            a.click();
        }
    </script>
</body>
</html>
